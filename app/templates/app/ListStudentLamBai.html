{% load static %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% block name-title %}
            Danh sách bài thi trắc nghiệm
        {% endblock name-title %}
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'css/main.css'%}">

    <link rel="stylesheet" href="{% static 'css/home.css'%}">

    {% block link-css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="{% static 'css/tableStudent.css' %}">
    <style>
        #dichuyen{
            position: sticky;
            top: 20px;
        }
    </style>
    {% endblock link-css %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container-fluid p-0 ">
        <div class="sidebar close_menu">
            <div class="logo-details">
                <!-- <i class="fa-solid fa-house"></i> -->
                <a href="">
                    <img src="{%static 'image/logoTronTruongKHTN.png'%}" alt="logo">
                </a>
                <span class="logo-name">Biểu diễn tri thức</span>
            </div>
            <ul class="nav-links">
                <li>
                    <div class="icon-link">
                        <a href=" " style="height: 50px; font-size: 12px;">
                            <i class="fa-solid fa-address-book" style="color: #ffffff;"></i>
                            <span class="link_name">Danh sách lớp</span>
                        </a>
                        <i class="fa-solid fa-caret-down arrow"></i>
                    </div>
                    <ul class="sub-menu" id="mySubMenuClass">
                        <li>
                            <a class="link_name" href="" >Danh sách lớp</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="" style="height: 50px; font-size: 12px;">
                        <i class="fa-solid fa-list fa-2xl" style="color: #ffffff;"></i>
                        <span class="link_name">Danh sách bài thi</span>
                    </a>
                    <ul class="sub-menu blank">
                        <li><a class="link_name" href="">Danh sách bài thi</a></li>
                    </ul>
                </li>

                <li>
                    <a href="" style="height: 50px; font-size: 12px;">
                        <i class="fa-solid fa-list-ol fa-2xl" style="color: #ffffff;"></i>
                        <span class="link_name">Danh sách câu hỏi</span>
                    </a>
                    <ul class="sub-menu blank">
                        <li><a class="link_name" href="">Danh sách câu hỏi</a></li>
                    </ul>
                </li>

                <li>
                    <div class="icon-link">
                        <a href=" " style="height: 50px; font-size: 12px;">
                            <i class="fa-solid fa-chart-simple fa-2xl" style="color: #ffffff;"></i>
                            <span class="link_name">Thống kê</span>
                        </a>
                        <i class="fa-solid fa-caret-down arrow"></i>
                    </div>
                    <ul class="sub-menu" id="mySubMenuClass">
                        <li>
                            <a class="link_name" href="" >Thống kê</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href=""  style="height: 50px; font-size: 12px;">
                        <i class="fa-solid fa-key"></i>
                        <span class="link_name">Đổi mật khẩu</span>
                    </a>
                    <ul class="sub-menu blank">
                        <li><a class="link_name" href="">Đổi mật khẩu</a></li>
                    </ul>
                </li>
                <li>
                    <form action="" method="post">
                        <a href=""><i class="fa-sharp fa-solid fa-right-from-bracket"></i>
                        <span class="link_name">Đăng Xuất</span></a>         
                    </form>
                    <ul class="sub-menu blank">
                        <li><a class="link_name" href="">Đăng Xuất</a></li>
                    </ul>
                </li>
                <li>
                    <div class="profile-details">
                        <div class="profile-content">
                            <a href="">
                                <img src="{%static 'image/no-avatar.png'%}" alt="profile">
                            </a>
                        </div>
                        <div class="name-job pr-3">
                            <div class="profile_name">
                                Nguyễn Đình Thanh
                            </div>
                            <div class="job">Teacher</div>
                        </div>               
                    </div>
                </li>
            </ul>
        </div>
        <section class="home-section">
            <div class="home-content">
                <i class="fa-solid fa-bars"></i>
                <span class="text">Trang chủ</span>
            </div>
            {% block main-content %}
            <div class="home-dashboard d-block" style="height: auto;">
                <div class="row ml-3 mr-3">
                    <div class="col-md-4 d-flex justify-content-center">
                        <div id="dichuyen" class="khung d-flex flex-column flex-wrap align-content-around" style="border: 2px solid red; width: 200px;height: fit-content; border-radius: 10px;">
                            {% for row in soHang %}
                                <div class="row mt-1">
                                {% for col in soCot %}
                                    {% if row|mul:soCot|length|add:col|add:1 <= list_cauhoiKiemTra|length  %}
                                        <div class="col-md-3 pl-1 pr-2">
                                            <p id="CauHoi{{row|mul:soCot|length|add:col|add:1}}" class="text-center" style="border: 1px solid green; width: 30px; border-radius: 10px;">
                                                <a href="#Cau{{row|mul:soCot|length|add:col|add:1}}" class="text-decoration-none text-body" id="text_done_{{row|mul:soCot|length|add:col|add:1}}">{{row|mul:soCot|length|add:col|add:1}}</a>
                                            </p>
                                        </div>
                                    {% endif %} 
                                {% endfor %}
                                </div> 
                            {% endfor %}
                            {% comment %} <div class="row mt-1">
                                <div class="col-md-3 pl-1 pr-2">
                                    <p id="CauHoi1" class="text-center text-black-50" style="border: 1px solid green; width: 30px; border-radius: 10px;">
                                        <a href="#Cau1" class="text-decoration-none">1</a>
                                    </p>
                                </div>
                                <div class="col-md-3 pl-1 pr-2">
                                    <p id="CauHoi2" class="text-center text-black-50" style="border: 1px solid green; width: 30px; border-radius: 10px;">
                                        <a href="#Cau2" class="text-decoration-none">2</a>
                                    </p>
                                </div>
                                <div class="col-md-3 pl-1 pr-2">
                                    <p id="CauHoi3" class="text-center text-black-50" style="border: 1px solid green; width: 30px; border-radius: 10px;">
                                        <a href="#Cau3" class="text-decoration-none">3</a>
                                    </p>
                                </div>
                                <div class="col-md-3 pl-1 pr-2">
                                    <p id="CauHoi4" class="text-center text-black-50" style="border: 1px solid green; width: 30px; border-radius: 10px;">
                                        <a href="#Cau4" class="text-decoration-none">4</a>
                                    </p>
                                </div>
                            </div>   {% endcomment %}
                                
                            <div class="row mt-1">
                                <div class="col-md-12 pl-1 pr-2">
                                    <p>Thời gian còn lại: <span id="countdown"></span></p>
                                </div>
                            </div>
                            <div class="row mt-1 mb-1">
                                <div class="col-md-12 pl-1 pr-2">
                                    <input type="button" name="edit" id=""  class="btn btn-block btn-success done_test" value="Làm xong">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        {% for stt,i in socauhoi_list %}
                            <div id="Cau{{stt|add:1}}" class="mb-3" data-macauhoi="{{i.cauhoi_macauhoi__macauhoi}}">
                                <strong>Câu {{stt|add:1}}: </strong> {{i.cauhoi_macauhoi__noidung}}
                                <br>
                                <input type="radio" name="c{{stt|add:1}}" id="c{{stt|add:1}}a" value="{{i.cauhoi_macauhoi__dapana}}"> <label for="c{{stt|add:1}}a">
                                    A. {{i.cauhoi_macauhoi__dapana}}
                                </label>
                                <br>
                                <input type="radio" name="c{{stt|add:1}}" id="c{{stt|add:1}}b" value="{{i.cauhoi_macauhoi__dapanb}}"> 
                                <label for="c{{stt|add:1}}b">
                                    B. {{i.cauhoi_macauhoi__dapanb}}
                                </label>
                                <br>
                                <input type="radio" name="c{{stt|add:1}}" id="c{{stt|add:1}}c" value="{{i.cauhoi_macauhoi__dapanc}}">
                                <label for="c{{stt|add:1}}c">
                                    C. {{i.cauhoi_macauhoi__dapanc}}
                                </label>
                                <br>
                                <input type="radio" name="c{{stt|add:1}}" id="c{{stt|add:1}}d" value="{{i.cauhoi_macauhoi__dapand}}">
                                <label for="c{{stt|add:1}}d">
                                    D. {{i.cauhoi_macauhoi__dapand}}
                                </label>
                            </div>
                        {% endfor %}
                        {% comment %} <div id="Cau1" class="mb-3">
                            <strong>Câu 1: </strong> Tam giác là gì?
                            <br>
                            <input type="radio" name="c1" id="c1a" value="Tam giác là một hình học"> A. Tam giác là một hình học
                            <br>
                            <input type="radio" name="c1" id="c1b" value="Tam giác là một hình học"> B. Tam giác là một hình học
                            <br>
                            <input type="radio" name="c1" id="c1c" value="Tam giác là một hình học"> C. Tam giác là một hình học
                            <br>
                            <input type="radio" name="c1" id="c1d" value="Tam giác là một hình học"> D. Tam giác là một hình học
                        </div> {% endcomment %}
                        <div class="row mt-1 mb-1">
                            <div class="col-md-12 pl-1 pr-2">
                                <input type="button" name="edit" class="btn btn-block btn-success done_test" value="Làm xong">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock main-content %}
        </section>
    </div>
    
    {% block script-js %}
    <script type="text/javascript" src="//code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{%static 'js/base.js'%}"></script>
    <script>
        $(document).ready(function(){
            var len_cauhoi= {{list_cauhoiKiemTra|length}};
            var makt='{{list_cauhoiKiemTra.0.makt__makt}}'
            var malskt='{{malskt}}'
            function get_json_data(){
                var json_dapan={}
                for(let i = 1; i <= len_cauhoi; i++){
                    $(`input[name="c${i}"]`).each(function(){
                        if($(this).is(':checked')){
                            var macauhoi = $(this).parent().data('macauhoi');
                            var dapan = $(this).val();
                            json_dapan[macauhoi]=dapan
                        }
                    })
                }
                return json_dapan
            }
            var thoigiankiemtra="{{list_cauhoiKiemTra.0.makt__thoigian}}".split(":")[0];
            // console.log(thoigiankiemtra);
            var countDownTime = thoigiankiemtra;
            var timeLeft = countDownTime * 60;
            var timeout=false;
            
            var countdown = setInterval(function() {
                // Tính toán giờ, phút và giây còn lại
                var hours = Math.floor(timeLeft / 3600);
                var minutes = Math.floor((timeLeft - (hours * 3600)) / 60);
                var seconds = timeLeft - (hours * 3600) - (minutes * 60);

                // Hiển thị kết quả tính toán trong thẻ span
                $("#countdown").html(hours + ":" + minutes + ":" + seconds);

                // Giảm thời gian đếm ngược đi 1 giây
                timeLeft--;

                // Kiểm tra nếu thời gian đếm ngược bằng 0 thì dừng đồng hồ đếm ngược
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    timeout=true;
                    $("#countdown").html("Hết giờ!");
                    json_dapan=get_json_data()
                    $.ajax({
                        url: "{% url 'listStudentLamBai' 'list_cauhoiKiemTra.0.makt__makt' %}",
                        type: 'POST',
                        data: {
                            'maHS': "1010TB",
                            'ma_de_thi': makt,
                            'ma_lskt': malskt,
                            'time_kiem_tra': countDownTime*60,
                            'time_student_done': timeLeft,
                            'dap_an_tra_loi': JSON.stringify(json_dapan),
                            'csrfmiddlewaretoken': '{{csrf_token}}'
                        },
                        success: function(data){
                            alert("Hết giờ, nộp bài thành công");
                            location.href = "{% url 'resultTest' list_cauhoiKiemTra.0.makt__makt malskt '1010TB'%}";
                            // location.reload();
                        },
                        error: function(){
                            alert("Hết giờ, nộp bài thất bại");
                        }
                    });
                }
            }, 1000);
            // json_dapan={}
            $('.done_test').click(function(){
                json_dapan=get_json_data()
                $.ajax({
                    url: "{% url 'listStudentLamBai' list_cauhoiKiemTra.0.makt__makt %}",
                    type: 'POST',
                    data: {
                        'maHS': "1010TB",
                        'ma_de_thi': makt,
                        'ma_lskt': malskt,
                        'time_kiem_tra': thoigiankiemtra*60,
                        'time_student_done': timeLeft,
                        'dap_an_tra_loi': JSON.stringify(json_dapan),
                        'csrfmiddlewaretoken': '{{csrf_token}}'
                    },
                    success: function(data){
                        alert("Nộp bài thành công");
                        location.href = "{% url 'resultTest' list_cauhoiKiemTra.0.makt__makt malskt '1010TB'%}";
                        // location.reload();
                    },
                    error: function(){
                        alert("Nộp bài thất bại");
                    }
                });
            })

            $(document).change(
                function()
                {
                    for(let i = 1; i <= len_cauhoi; i++){
                        let lastCheckedRadio = null;
                        $('input[name="c'+i+'"]').click(function() {
                            const radio = $(this);
                            if (radio.is(lastCheckedRadio)) {
                                radio.prop('checked', false);
                                lastCheckedRadio = null;
                                $('#CauHoi'+i).removeClass('bg-success')
                                $('#text_done_'+i).removeClass('text-white')
                                $('#text_done_'+i).addClass('text-body')
                            } else {
                                lastCheckedRadio = radio;
                            }
                        });
                        cau_checked= $('input[name="c'+i+'"]:checked').val()
                        if (cau_checked != null)
                        {
                            $('#CauHoi'+i).addClass('bg-success')
                            $('#text_done_'+i).removeClass('text-body')
                            $('#text_done_'+i).addClass('text-white')
                        }
                    }
                }
            )
        })
    </script>
    {% endblock script-js %}
</body>
</html>